name: Coverage PR Comment

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: read

jobs:
  coverage-comment:
    name: Post Coverage Comment
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          pattern: '*coverage*'
          path: coverage-artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -R coverage-artifacts/

      - name: Parse backend coverage
        id: backend-coverage
        run: |
          if [ -f "coverage-artifacts/backend-coverage-report/cobertura.xml" ]; then
            # Extract line coverage percentage from Cobertura XML
            COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage-artifacts/backend-coverage-report/cobertura.xml | head -1)
            COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc -l | xargs printf "%.2f")
            echo "coverage=$COVERAGE_PCT" >> $GITHUB_OUTPUT
            echo "Backend Coverage: $COVERAGE_PCT%"
          else
            echo "coverage=N/A" >> $GITHUB_OUTPUT
            echo "Backend coverage report not found"
          fi

      - name: Parse frontend coverage
        id: frontend-coverage
        run: |
          if [ -f "coverage-artifacts/frontend-coverage/coverage-summary.json" ]; then
            # Extract total line coverage from Vitest JSON summary
            COVERAGE=$(jq -r '.total.lines.pct' coverage-artifacts/frontend-coverage/coverage-summary.json)
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "Frontend Coverage: $COVERAGE%"
          else
            echo "coverage=N/A" >> $GITHUB_OUTPUT
            echo "Frontend coverage report not found"
          fi

      - name: Find PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });

            if (pullRequests.length === 0) {
              console.log('No open PR found for this branch');
              return null;
            }

            const pr = pullRequests[0];
            console.log(`Found PR #${pr.number}`);
            return pr.number;

      - name: Post coverage comment
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const backendCov = '${{ steps.backend-coverage.outputs.coverage }}';
            const frontendCov = '${{ steps.frontend-coverage.outputs.coverage }}';

            // Calculate overall coverage (weighted average if both available)
            let overallCov = 'N/A';
            if (backendCov !== 'N/A' && frontendCov !== 'N/A') {
              overallCov = ((parseFloat(backendCov) + parseFloat(frontendCov)) / 2).toFixed(2);
            } else if (backendCov !== 'N/A') {
              overallCov = backendCov;
            } else if (frontendCov !== 'N/A') {
              overallCov = frontendCov;
            }

            // Determine emoji based on coverage
            const getEmoji = (cov) => {
              if (cov === 'N/A') return 'â“';
              const num = parseFloat(cov);
              if (num >= 80) return 'ðŸŸ¢';
              if (num >= 60) return 'ðŸŸ¡';
              return 'ðŸ”´';
            };

            const lines = [
              '## ðŸ“Š Coverage Report',
              '',
              '| Component | Coverage | Status |',
              '|-----------|----------|--------|',
              `| Backend | ${backendCov}% | ${getEmoji(backendCov)} |`,
              `| Frontend | ${frontendCov}% | ${getEmoji(frontendCov)} |`,
              `| **Overall** | **${overallCov}%** | **${getEmoji(overallCov)}** |`,
              '',
              '### Coverage Thresholds',
              '- ðŸŸ¢ Green: â‰¥ 80% (target)',
              '- ðŸŸ¡ Yellow: 60-79% (acceptable)',
              '- ðŸ”´ Red: < 60% (needs improvement)',
              '',
              '---',
              `*Coverage reports generated by [CI workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})*`
            ];
            const comment = lines.join('\n');

            // Find existing coverage comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing coverage comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              console.log('Created new coverage comment');
            }
